<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Publisher V2 Web</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #0f172a;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 0.75rem 1rem;
      background-color: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 1.1rem;
      margin: 0;
    }
    main {
      flex: 1;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .image-container {
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #020617;
      border-radius: 0.75rem;
      padding: 0.75rem;
      border: 1px solid #1f2937;
      max-width: min(100%, 1280px);
      width: 100%;
      margin: 0 auto;
    }
    .image-container img {
      max-width: 100%;
      height: auto;
      border-radius: 0.5rem;
      object-fit: contain;
    }
    .controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    button {
      flex: 1 1 30%;
      padding: 0.75rem;
      border-radius: 9999px;
      border: none;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      color: #0f172a;
      background: linear-gradient(to right, #38bdf8, #22c55e);
    }
    button.secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .panel {
      background-color: #020617;
      border-radius: 0.75rem;
      padding: 0.75rem;
      border: 1px solid #1f2937;
      font-size: 0.9rem;
    }
    .panel h2 {
      font-size: 0.95rem;
      margin-top: 0;
    }
    .status {
      font-size: 0.85rem;
      color: #9ca3af;
      min-height: 1.2rem;
    }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Publisher V2 Web</h1>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
      <span id="env-indicator" class="status"></span>
      <button id="btn-admin" class="secondary" type="button">Administration</button>
    </div>
  </header>
  <main>
    <div class="image-container">
      <img id="image" alt="No image loaded yet" />
    </div>

    <div class="controls">
      <button id="btn-next">Next image</button>
      <button id="btn-analyze" class="secondary">Analyze &amp; caption</button>
      <button id="btn-publish" class="secondary">Publish</button>
    </div>

    <div class="panel" id="panel-caption">
      <h2>Caption</h2>
      <div id="caption-text">No caption yet.</div>
    </div>

    <div class="panel" id="panel-admin">
      <h2>Administration</h2>
      <div id="admin-mode-indicator" class="status">Admin mode: off</div>
      <form id="admin-login-form">
        <input
          type="password"
          id="admin-password"
          placeholder="Admin password"
          autocomplete="current-password"
          style="flex: 1 1 auto; padding: 0.4rem; border-radius: 9999px; border: 1px solid #374151; background-color: #020617; color: #e5e7eb;"
        />
        <button type="submit" class="secondary" style="margin-top: 0.5rem;">Unlock admin mode</button>
      </form>
      <button id="btn-admin-logout" class="secondary" type="button" style="margin-top: 0.5rem;">Exit admin mode</button>
      <div id="admin-message" class="status"></div>
    </div>

    <div class="panel" id="panel-status">
      <h2>Status</h2>
      <div id="status" class="status">Ready.</div>
      <div id="details"></div>
    </div>
  </main>

  <script>
    const imgEl = document.getElementById("image");
    const statusEl = document.getElementById("status");
    const detailsEl = document.getElementById("details");
    const captionEl = document.getElementById("caption-text");
    const btnNext = document.getElementById("btn-next");
    const btnAnalyze = document.getElementById("btn-analyze");
    const btnPublish = document.getElementById("btn-publish");
    const btnAdmin = document.getElementById("btn-admin");
    const adminModeIndicator = document.getElementById("admin-mode-indicator");
    const adminForm = document.getElementById("admin-login-form");
    const adminPasswordInput = document.getElementById("admin-password");
    const adminMessage = document.getElementById("admin-message");
    const btnAdminLogout = document.getElementById("btn-admin-logout");

    let currentFilename = null;
    let isAdmin = false;

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function setDetails(html) {
      if (!isAdmin) {
        detailsEl.innerHTML = "<div>Admin-only details are hidden.</div>";
        return;
      }
      detailsEl.innerHTML = html || "";
    }

    function setCaption(text) {
      captionEl.textContent = text || "No caption yet.";
    }

    function disableButtons(disabled) {
      btnNext.disabled = disabled;
      btnAnalyze.disabled = disabled || !isAdmin;
      btnPublish.disabled = disabled || !isAdmin;
    }

    function updateAdminUI() {
      adminModeIndicator.textContent = isAdmin ? "Admin mode: on" : "Admin mode: off";
      // Analyze/Publish are always gated by admin mode
      btnAnalyze.disabled = !isAdmin;
      btnPublish.disabled = !isAdmin;
      // Refresh details panel to respect admin visibility
      if (!isAdmin) {
        detailsEl.innerHTML = "<div>Admin-only details are hidden.</div>";
      }
    }

    async function refreshAdminStatus() {
      try {
        const res = await fetch("/api/admin/status");
        if (!res.ok) {
          isAdmin = false;
        } else {
          const data = await res.json();
          isAdmin = !!data.admin;
        }
      } catch (e) {
        console.error(e);
        isAdmin = false;
      }
      updateAdminUI();
    }

    async function apiGetRandom() {
      setStatus("Loading random image…");
      disableButtons(true);
      try {
        const res = await fetch("/api/images/random");
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || err.error || "Failed to load image");
        }
        const data = await res.json();
        currentFilename = data.filename;
        imgEl.src = data.temp_url;
        imgEl.alt = data.caption || data.sd_caption || data.filename;
        setCaption(data.caption || data.sd_caption || "No caption yet.");
        const meta = data.metadata ? JSON.stringify(data.metadata, null, 2) : "None";
        setDetails(`<div><strong>File:</strong> ${data.filename}</div><pre><code>${meta}</code></pre>`);
        setStatus("Image loaded.");
      } catch (e) {
        console.error(e);
        currentFilename = null;
        imgEl.src = "";
        setCaption(null);
        setDetails("");
        setStatus(e.message || "Error loading image.");
      } finally {
        disableButtons(false);
      }
    }

    async function apiAnalyze() {
      if (!currentFilename) {
        setStatus("No image selected.");
        return;
      }
      if (!isAdmin) {
        setStatus("Admin mode required to analyze.");
        return;
      }
      setStatus("Analyzing image…");
      disableButtons(true);
      try {
        const res = await fetch(`/api/images/${encodeURIComponent(currentFilename)}/analyze`, {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || err.error || "Failed to analyze image");
        }
        const data = await res.json();
        setCaption(data.caption || data.sd_caption || "No caption generated.");
        const meta = {
          description: data.description,
          mood: data.mood,
          nsfw: data.nsfw,
          tags: data.tags
        };
        setDetails(`<div><strong>Analysis:</strong></div><pre><code>${JSON.stringify(meta, null, 2)}</code></pre>`);
        setStatus("Analysis complete; caption generated.");
      } catch (e) {
        console.error(e);
        setStatus(e.message || "Error analyzing image.");
      } finally {
        disableButtons(false);
      }
    }

    async function apiPublish() {
      if (!currentFilename) {
        setStatus("No image selected.");
        return;
      }
      if (!isAdmin) {
        setStatus("Admin mode required to publish.");
        return;
      }
      setStatus("Publishing image…");
      disableButtons(true);
      try {
        const res = await fetch(`/api/images/${encodeURIComponent(currentFilename)}/publish`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({})
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || err.error || "Failed to publish image");
        }
        const data = await res.json();
        const results = JSON.stringify(data.results || {}, null, 2);
        setDetails(`<div><strong>Publish results:</strong></div><pre><code>${results}</code></pre>`);
        if (data.any_success) {
          setStatus(`Published successfully${data.archived ? " and archived." : "."}`);
        } else {
          setStatus("No platforms reported success; see details.");
        }
      } catch (e) {
        console.error(e);
        setStatus(e.message || "Error publishing image.");
      } finally {
        disableButtons(false);
      }
    }

    async function handleAdminLogin(event) {
      event.preventDefault();
      adminMessage.textContent = "";
      const password = adminPasswordInput.value || "";
      if (!password) {
        adminMessage.textContent = "Please enter the admin password.";
        return;
      }
      try {
        const res = await fetch("/api/admin/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.admin) {
          isAdmin = false;
          adminMessage.textContent = data.detail || data.error || "Invalid admin password.";
        } else {
          isAdmin = true;
          adminMessage.textContent = "Admin mode enabled.";
        }
      } catch (e) {
        console.error(e);
        isAdmin = false;
        adminMessage.textContent = "Error logging in as admin.";
      } finally {
        adminPasswordInput.value = "";
        updateAdminUI();
      }
    }

    async function handleAdminLogout() {
      adminMessage.textContent = "";
      try {
        const res = await fetch("/api/admin/logout", {
          method: "POST",
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          adminMessage.textContent = data.detail || data.error || "Error logging out of admin mode.";
        } else {
          isAdmin = false;
          adminMessage.textContent = "Admin mode disabled.";
        }
      } catch (e) {
        console.error(e);
        adminMessage.textContent = "Error logging out of admin mode.";
      } finally {
        updateAdminUI();
      }
    }

    btnNext.addEventListener("click", apiGetRandom);
    btnAnalyze.addEventListener("click", apiAnalyze);
    btnPublish.addEventListener("click", apiPublish);
    btnAdmin.addEventListener("click", () => {
      adminForm.scrollIntoView({ behavior: "smooth", block: "center" });
      adminPasswordInput.focus();
    });
    adminForm.addEventListener("submit", handleAdminLogin);
    btnAdminLogout.addEventListener("click", handleAdminLogout);

    // On load, check admin status then load first image
    window.addEventListener("load", async () => {
      await refreshAdminStatus();
      await apiGetRandom();
    });
  </script>
</body>
</html>


