<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Publisher V2 Web</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #0f172a;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: background-color 0.2s ease;
    }
    body.admin-mode {
      background-color: #8b0000;
    }
    header {
      padding: 0.75rem 1rem;
      background-color: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }
    header h1 {
      font-size: 1.1rem;
      margin: 0;
    }
    .header-left,
    .header-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    main {
      flex: 1;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-width: 960px;
      width: 100%;
      margin: 0 auto;
    }
    .image-container {
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #020617;
      border-radius: 0.75rem;
      padding: 0.75rem;
      border: 1px solid #1f2937;
      max-width: min(100%, 1280px);
      width: 100%;
      margin: 0 auto;
    }
    .image-container img {
      max-width: 100%;
      height: auto;
      border-radius: 0.5rem;
      object-fit: contain;
    }
    .controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    button {
      flex: 1 1 30%;
      padding: 0.75rem;
      border-radius: 9999px;
      border: none;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      color: #0f172a;
      background: linear-gradient(to right, #38bdf8, #22c55e);
    }
    button.secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .panel {
      background-color: #020617;
      border-radius: 0.75rem;
      padding: 0.75rem;
      border: 1px solid #1f2937;
      font-size: 0.9rem;
    }
    .panel h2 {
      font-size: 0.95rem;
      margin-top: 0;
    }
    .status {
      font-size: 0.85rem;
      color: #9ca3af;
      min-height: 1.2rem;
    }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
    }
    .hidden {
      display: none !important;
    }
    .admin-only {
      /* marker class; actual visibility controlled via .hidden */
    }
    /* Simple modal styles */
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(15, 23, 42, 0.8);
      z-index: 50;
    }
    .modal-dialog {
      background-color: #020617;
      border-radius: 0.75rem;
      padding: 1rem;
      border: 1px solid #1f2937;
      width: 100%;
      max-width: 22rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
    }
    .modal-dialog h2 {
      margin-top: 0;
      font-size: 1rem;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <h1>Publisher V2 Web</h1>
    </div>
    <div class="header-right">
      <span id="env-indicator" class="status"></span>
      <button id="btn-admin" class="secondary" type="button">Admin</button>
      <button id="btn-admin-logout" class="secondary admin-only hidden" type="button">Logout</button>
    </div>
  </header>

  <div id="admin-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="admin-modal-title">
    <div class="modal-dialog">
      <h2 id="admin-modal-title">Admin login</h2>
      <p class="status" id="admin-modal-description">Enter the admin password to enable analysis and publishing.</p>
      <form id="admin-login-form">
        <input
          type="password"
          id="admin-password"
          placeholder="Admin password"
          autocomplete="current-password"
          style="width: 100%; padding: 0.5rem; border-radius: 9999px; border: 1px solid #374151; background-color: #020617; color: #e5e7eb;"
        />
        <div class="modal-footer">
          <button type="button" id="admin-modal-close" class="secondary">Cancel</button>
          <button type="submit">Login</button>
        </div>
      </form>
      <div id="admin-message" class="status"></div>
    </div>
  </div>
  <main>
    <div class="image-container">
      <img id="image" alt="No image loaded yet" />
    </div>

    <div class="controls">
      <button id="btn-next">Next image</button>
      <div id="admin-controls" class="controls admin-only hidden">
        <button id="btn-analyze" class="secondary">Analyze &amp; caption</button>
        <button id="btn-publish" class="secondary">Publish</button>
      </div>
    </div>

    <div class="panel" id="panel-caption">
      <h2>Caption</h2>
      <div id="caption-text">No caption yet.</div>
    </div>

    <div class="panel admin-only hidden" id="panel-admin">
      <h2>Administration</h2>
      <div id="admin-mode-indicator" class="status">Admin mode: off</div>
      <div class="status">Admin-only controls are active while you are logged in.</div>
    </div>

    <div class="panel admin-only hidden" id="panel-activity">
      <h2>Activity</h2>
      <div id="status" class="status">Ready.</div>
      <div id="details"></div>
    </div>
  </main>

  <script>
    const bodyEl = document.body;
    const imgEl = document.getElementById("image");
    const statusEl = document.getElementById("status");
    const detailsEl = document.getElementById("details");
    const captionEl = document.getElementById("caption-text");
    const btnNext = document.getElementById("btn-next");
    const btnAnalyze = document.getElementById("btn-analyze");
    const btnPublish = document.getElementById("btn-publish");
    const btnAdmin = document.getElementById("btn-admin");
    const btnAdminLogout = document.getElementById("btn-admin-logout");
    const adminControls = document.getElementById("admin-controls");
    const panelAdmin = document.getElementById("panel-admin");
    const panelActivity = document.getElementById("panel-activity");
    const adminModeIndicator = document.getElementById("admin-mode-indicator");
    const adminForm = document.getElementById("admin-login-form");
    const adminPasswordInput = document.getElementById("admin-password");
    const adminMessage = document.getElementById("admin-message");
    const adminModal = document.getElementById("admin-modal");
    const adminModalClose = document.getElementById("admin-modal-close");

    let currentFilename = null;
    let isAdmin = false;

    function setActivity(msg) {
      statusEl.textContent = msg || "";
    }

    function setDetails(html) {
      if (!isAdmin) {
        detailsEl.innerHTML = "<div>Admin-only details are hidden.</div>";
        return;
      }
      detailsEl.innerHTML = html || "";
    }

    function setCaption(text) {
      captionEl.textContent = text || "No caption yet.";
    }

    function disableButtons(disabled) {
      btnNext.disabled = disabled;
      if (btnAnalyze && btnPublish) {
        btnAnalyze.disabled = disabled || !isAdmin;
        btnPublish.disabled = disabled || !isAdmin;
      }
    }

    function updateAdminUI() {
      adminModeIndicator.textContent = isAdmin ? "Admin mode: on" : "Admin mode: off";
      if (isAdmin) {
        bodyEl.classList.add("admin-mode");
        adminControls.classList.remove("hidden");
        panelAdmin.classList.remove("hidden");
        panelActivity.classList.remove("hidden");
        btnAdmin.classList.add("hidden");
        btnAdminLogout.classList.remove("hidden");
      } else {
        bodyEl.classList.remove("admin-mode");
        adminControls.classList.add("hidden");
        panelAdmin.classList.add("hidden");
        panelActivity.classList.add("hidden");
        btnAdmin.classList.remove("hidden");
        btnAdminLogout.classList.add("hidden");
        detailsEl.innerHTML = "<div>Admin-only details are hidden.</div>";
      }
      if (btnAnalyze && btnPublish) {
        btnAnalyze.disabled = !isAdmin;
        btnPublish.disabled = !isAdmin;
      }
    }

    async function fetchAdminStatus() {
      try {
        const res = await fetch("/api/admin/status");
        if (!res.ok) {
          return false;
        }
        const data = await res.json();
        return !!data.admin;
      } catch (e) {
        console.error(e);
        return false;
      }
    }

    function updateAdminState(admin) {
      isAdmin = !!admin;
      updateAdminUI();
    }

    async function refreshAdminStatus() {
      const admin = await fetchAdminStatus();
      updateAdminState(admin);
    }

    async function apiGetRandom() {
      setActivity("Loading random image…");
      disableButtons(true);
      try {
        const res = await fetch("/api/images/random");
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || err.error || "Failed to load image");
        }
        const data = await res.json();
        currentFilename = data.filename;
        imgEl.src = data.temp_url;
        imgEl.alt = data.caption || data.sd_caption || data.filename;
        setCaption(data.caption || data.sd_caption || "No caption yet.");
        const meta = data.metadata ? JSON.stringify(data.metadata, null, 2) : "None";
        setDetails(`<div><strong>File:</strong> ${data.filename}</div><pre><code>${meta}</code></pre>`);
        setActivity("Image loaded.");
      } catch (e) {
        console.error(e);
        currentFilename = null;
        imgEl.src = "";
        setCaption(null);
        setDetails("");
        setActivity(e.message || "Error loading image.");
      } finally {
        disableButtons(false);
      }
    }

    async function apiAnalyze() {
      if (!currentFilename) {
        setActivity("No image selected.");
        return;
      }
      if (!isAdmin) {
        setActivity("Admin mode required to analyze.");
        return;
      }
      setActivity("Analyzing image…");
      disableButtons(true);
      try {
        const res = await fetch(`/api/images/${encodeURIComponent(currentFilename)}/analyze`, {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          if (res.status === 401 || res.status === 403) {
            updateAdminState(false);
            throw new Error("Admin session expired, please log in again.");
          }
          throw new Error(err.detail || err.error || "Failed to analyze image");
        }
        const data = await res.json();
        setCaption(data.caption || data.sd_caption || "No caption generated.");
        const meta = {
          description: data.description,
          mood: data.mood,
          nsfw: data.nsfw,
          tags: data.tags
        };
        setDetails(`<div><strong>Analysis:</strong></div><pre><code>${JSON.stringify(meta, null, 2)}</code></pre>`);
        setActivity("Analysis complete; caption generated.");
      } catch (e) {
        console.error(e);
        const msg = e.message || "Error analyzing image.";
        setActivity(msg);
      } finally {
        disableButtons(false);
      }
    }

    async function apiPublish() {
      if (!currentFilename) {
        setActivity("No image selected.");
        return;
      }
      if (!isAdmin) {
        setActivity("Admin mode required to publish.");
        return;
      }
      setActivity("Publishing image…");
      disableButtons(true);
      try {
        const res = await fetch(`/api/images/${encodeURIComponent(currentFilename)}/publish`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({})
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          if (res.status === 401 || res.status === 403) {
            updateAdminState(false);
            throw new Error("Admin session expired, please log in again.");
          }
          throw new Error(err.detail || err.error || "Failed to publish image");
        }
        const data = await res.json();
        const results = JSON.stringify(data.results || {}, null, 2);
        setDetails(`<div><strong>Publish results:</strong></div><pre><code>${results}</code></pre>`);
        if (data.any_success) {
          setActivity(`Publish complete${data.archived ? " and archived." : "."}`);
        } else {
          setActivity("Publish completed but no platforms reported success; see details.");
        }
      } catch (e) {
        console.error(e);
        const msg = e.message || "Error publishing image.";
        setActivity(msg);
      } finally {
        disableButtons(false);
      }
    }

    async function handleAdminLogin(event) {
      event.preventDefault();
      adminMessage.textContent = "";
      const password = adminPasswordInput.value || "";
      if (!password) {
        adminMessage.textContent = "Please enter the admin password.";
        return;
      }
      try {
        const res = await fetch("/api/admin/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.admin) {
          isAdmin = false;
          adminMessage.textContent = data.detail || data.error || "Invalid admin password.";
        } else {
          updateAdminState(true);
          adminMessage.textContent = "Admin mode enabled.";
          setActivity("Admin mode enabled.");
          adminModal.classList.add("hidden");
        }
      } catch (e) {
        console.error(e);
        isAdmin = false;
        adminMessage.textContent = "Error logging in as admin.";
      } finally {
        adminPasswordInput.value = "";
      }
    }

    async function handleAdminLogout() {
      adminMessage.textContent = "";
      try {
        const res = await fetch("/api/admin/logout", {
          method: "POST",
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          adminMessage.textContent = data.detail || data.error || "Error logging out of admin mode.";
        } else {
          updateAdminState(false);
          adminMessage.textContent = "Admin mode disabled.";
          setActivity("Admin mode disabled.");
        }
      } catch (e) {
        console.error(e);
        adminMessage.textContent = "Error logging out of admin mode.";
      } finally {
      }
    }

    function initAdminControls() {
      btnAdmin.addEventListener("click", () => {
        adminModal.classList.remove("hidden");
        adminPasswordInput.focus();
      });
      adminModalClose.addEventListener("click", () => {
        adminModal.classList.add("hidden");
        adminMessage.textContent = "";
      });
      adminModal.addEventListener("click", (event) => {
        if (event.target === adminModal) {
          adminModal.classList.add("hidden");
          adminMessage.textContent = "";
        }
      });
      adminForm.addEventListener("submit", handleAdminLogin);
      btnAdminLogout.addEventListener("click", handleAdminLogout);
    }

    function initLayout() {
      btnNext.addEventListener("click", apiGetRandom);
      if (btnAnalyze && btnPublish) {
        btnAnalyze.addEventListener("click", apiAnalyze);
        btnPublish.addEventListener("click", apiPublish);
      }
      initAdminControls();
      window.addEventListener("load", async () => {
        updateAdminState(false);
        await refreshAdminStatus();
        await apiGetRandom();
      });
    }

    initLayout();
  </script>
</body>
</html>


