version: 1
feature_id: keep-remove-curation
summary: "Add admin-only Keep/Remove curation actions in the V2 web UI and workflow that move images (and sidecars) into configurable Dropbox subfolders, with env/INI config, feature flags, preview safety, and admin protections."
design_refs:
  - docs_v2/08_Features/08_02_Feature_Design/010_keep-remove-curation_design.md
repo_constraints:
  allowed_paths:
    - publisher_v2/src/publisher_v2/**
    - publisher_v2/tests/**
    - docs_v2/**
    - configfiles/**
  excluded_paths:
    - code_v1/**
    - docs_v1/**
    - htmlcov/**
    - coverage.xml
    - coverage-current.xml

acceptance_criteria:
  - "Given an authenticated admin viewing an image in the web UI with [Dropbox].folder_keep configured and FEATURE_KEEP_CURATE=true, when they click Keep, then the image and its sidecars are moved via Dropbox server-side into image_folder/folder_keep and the UI advances to the next image."
  - "Given an authenticated admin viewing an image in the web UI with [Dropbox].folder_remove or legacy folder_reject configured and FEATURE_REMOVE_CURATE=true, when they click Remove, then the image and its sidecars are moved into image_folder/folder_remove (or folder_reject) and no longer appear as candidates."
  - "Given the workflow runs in preview or dry mode, when keep_image/remove_image is invoked through the orchestrator, then no Dropbox moves occur and preview utilities print what would happen."
  - "Given FEATURE_KEEP_CURATE=false or FEATURE_REMOVE_CURATE=false, when the web UI loads or the corresponding endpoint is called, then Keep/Remove controls are hidden and the API returns 403 for those actions."
  - "Given [Dropbox].folder_keep and [Dropbox].folder_remove are set in INI and/or overridden via .env (folder_keep, folder_remove), when the config loader runs, then DropboxConfig exposes these values with legacy folder_reject mapped to folder_remove if missing."
  - "Given malformed keep/remove folder values containing slashes or '..', when configuration is loaded, then a ConfigurationError is raised and the app fails fast."

non_goals:
  - "Add batch/multi-image curation workflows or queues."
  - "Introduce hard delete of images or sidecars."
  - "Change archive/publish semantics beyond reusing a shared Dropbox move helper."
  - "Add new databases or modify sidecar JSON/text schemas."
  - "Expose Keep/Remove via new CLI flags (web-only in this feature)."

tasks:
  # 1. Config & schema
  - id: keep_remove.extend_dropbox_schema
    type: code
    touches:
      - publisher_v2/src/publisher_v2/config/schema.py
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "class DropboxConfig(BaseModel)"
        - "class FeaturesConfig(BaseModel)"
    depends_on: []
    rollback: "Remove folder_keep/folder_remove from DropboxConfig and keep/remove flags from FeaturesConfig."

  - id: keep_remove.update_config_loader
    type: code
    touches:
      - publisher_v2/src/publisher_v2/config/loader.py
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "def load_application_config(config_file_path: str, env_path: str | None = None) -> ApplicationConfig"
        - "def parse_bool_env(value: str | None, default: bool = True, *, var_name: str | None = None) -> bool"
    depends_on:
      - keep_remove.extend_dropbox_schema
    rollback: "Remove keep/remove env parsing, legacy folder_reject aliasing, and new validation from config loader."

  # 2. Storage helpers
  - id: keep_remove.add_move_with_sidecars
    type: code
    touches:
      - publisher_v2/src/publisher_v2/services/storage.py
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "class DropboxStorage"
        - "async def move_image_with_sidecars(self, folder: str, filename: str, target_subfolder: str) -> None"
        - "async def archive_image(self, folder: str, filename: str, archive_folder: str) -> None"
    depends_on: []
    rollback: "Revert archive_image to inline move logic and remove move_image_with_sidecars."

  # 3. Workflow orchestration
  - id: keep_remove.add_orchestrator_curation_methods
    type: code
    touches:
      - publisher_v2/src/publisher_v2/core/workflow.py
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "class WorkflowOrchestrator"
        - "async def keep_image(self, filename: str, *, preview_mode: bool = False, dry_run: bool = False) -> None"
        - "async def remove_image(self, filename: str, *, preview_mode: bool = False, dry_run: bool = False) -> None"
    depends_on:
      - keep_remove.extend_dropbox_schema
      - keep_remove.add_move_with_sidecars
    rollback: "Remove keep_image/remove_image and any curation-specific logging or preview hooks from WorkflowOrchestrator."

  # 4. Preview helpers
  - id: keep_remove.update_preview_utils
    type: code
    touches:
      - publisher_v2/src/publisher_v2/utils/preview.py
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "def print_curation_action(filename: str, source_folder: str, target_subfolder: str, action: str) -> None"
        - "def print_preview_footer() -> None"
    depends_on:
      - keep_remove.add_orchestrator_curation_methods
    rollback: "Remove print_curation_action and any references from orchestrator preview flows."

  # 5. Web service & API
  - id: keep_remove.extend_web_models
    type: code
    touches:
      - publisher_v2/src/publisher_v2/web/models.py
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "class CurationResponse(BaseModel)"
    depends_on: []
    rollback: "Remove CurationResponse model."

  - id: keep_remove.extend_web_service
    type: code
    touches:
      - publisher_v2/src/publisher_v2/web/service.py
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "class WebImageService"
        - "async def keep_image(self, filename: str) -> CurationResponse | dict[str, object]"
        - "async def remove_image(self, filename: str) -> CurationResponse | dict[str, object]"
    depends_on:
      - keep_remove.add_orchestrator_curation_methods
      - keep_remove.extend_web_models
      - keep_remove.update_config_loader
    rollback: "Remove keep_image/remove_image from WebImageService."

  - id: keep_remove.extend_web_app_endpoints
    type: code
    touches:
      - publisher_v2/src/publisher_v2/web/app.py
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "@app.post('/api/images/{filename}/keep')"
        - "@app.post('/api/images/{filename}/remove')"
        - "@app.get('/api/config/features')"
    depends_on:
      - keep_remove.extend_web_service
    rollback: "Remove keep/remove endpoints and keep/remove keys from /api/config/features."

  # 6. Web UI template & JS
  - id: keep_remove.update_web_index_template
    type: code
    touches:
      - publisher_v2/src/publisher_v2/web/templates/index.html
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "id=\"btn-keep\""
        - "id=\"btn-remove\""
        - "let featureConfig = {"
        - "async function apiKeep()"
        - "async function apiRemove()"
    depends_on:
      - keep_remove.extend_web_app_endpoints
    rollback: "Remove Keep/Remove buttons and related JS from index.html."

  # 7. Configuration docs
  - id: keep_remove.update_configuration_docs
    type: doc
    touches:
      - docs_v2/05_Configuration/CONFIGURATION.md
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures: []
    depends_on:
      - keep_remove.update_config_loader
    rollback: "Remove keep/remove and FEATURE_KEEP_CURATE/FEATURE_REMOVE_CURATE documentation."

  # 8. Tests – config/env validation
  - id: keep_remove.tests_config_loader
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/test_config_keep_remove.py
    contracts:
      request: {}
      response: {}
      signatures:
        - "def test_dropbox_keep_remove_from_ini_and_env(monkeypatch) -> None"
        - "def test_dropbox_folder_reject_aliases_folder_remove(monkeypatch) -> None"
        - "def test_keep_remove_folder_invalid_values_raise_configuration_error(monkeypatch) -> None"
        - "def test_keep_remove_feature_flags_default_enabled(monkeypatch) -> None"
        - "def test_keep_remove_feature_flags_can_be_disabled(monkeypatch) -> None"
    depends_on:
      - keep_remove.update_config_loader
    rollback: ""

  # 9. Tests – storage moves
  - id: keep_remove.tests_storage_move_with_sidecars
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/test_dropbox_keep_remove_move.py
    contracts:
      request: {}
      response: {}
      signatures:
        - "async def test_move_image_with_sidecars_moves_image_and_txt(monkeypatch) -> None"
        - "async def test_move_image_with_sidecars_ignores_missing_sidecar(monkeypatch) -> None"
        - "async def test_archive_image_delegates_to_move_image_with_sidecars(monkeypatch) -> None"
    depends_on:
      - keep_remove.add_move_with_sidecars
    rollback: ""

  # 10. Tests – orchestrator curation
  - id: keep_remove.tests_orchestrator_curation
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/test_workflow_keep_remove.py
    contracts:
      request: {}
      response: {}
      signatures:
        - "async def test_keep_image_calls_storage_with_configured_folder(monkeypatch) -> None"
        - "async def test_remove_image_calls_storage_with_configured_folder(monkeypatch) -> None"
        - "async def test_keep_remove_preview_mode_uses_preview_helper(monkeypatch, capsys) -> None"
        - "async def test_keep_remove_feature_disabled_raises(monkeypatch) -> None"
    depends_on:
      - keep_remove.add_orchestrator_curation_methods
      - keep_remove.update_preview_utils
    rollback: ""

  # 11. Tests – web service & API
  - id: keep_remove.tests_web_service
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/web/test_web_keep_remove_service.py
    contracts:
      request: {}
      response: {}
      signatures:
        - "async def test_web_keep_image_delegates_to_orchestrator(monkeypatch) -> None"
        - "async def test_web_remove_image_delegates_to_orchestrator(monkeypatch) -> None"
        - "async def test_web_keep_remove_disabled_raises_permission(monkeypatch) -> None"
    depends_on:
      - keep_remove.extend_web_service
    rollback: ""

  - id: keep_remove.tests_web_endpoints_admin
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/web_integration/test_web_keep_remove_endpoints.py
    contracts:
      request: {}
      response: {}
      signatures:
        - "def test_keep_remove_require_admin(monkeypatch) -> None"
        - "def test_keep_remove_endpoint_success_flow(monkeypatch) -> None"
    depends_on:
      - keep_remove.extend_web_app_endpoints
    rollback: ""

quality_gates:
  tests_required:
    - keep_remove.tests_config_loader
    - keep_remove.tests_storage_move_with_sidecars
    - keep_remove.tests_orchestrator_curation
    - keep_remove.tests_web_service
    - keep_remove.tests_web_endpoints_admin
  coverage_delta_min: +3
  perf_budget:
    keep_remove_curation_p95_ms: 1000
  security_checks:
    - dep-audit
    - no-secrets
    - lint

release:
  strategy: gradual
  flags:
    - "FEATURE_KEEP_CURATE"
    - "FEATURE_REMOVE_CURATE"
  migration_notes:
    - "Existing configs using [Dropbox].folder_reject continue to work; folder_remove will be derived from folder_reject when not set."
    - "Keep/Remove controls are visible only when enabled via feature flags and configured folders; disabling flags restores current behavior."
    - "Preview/dry workflows remain non-destructive; Keep/Remove moves are no-ops in preview/dry."


