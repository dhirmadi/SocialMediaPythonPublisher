version: 1
feature_id: 007-cross-cutting-performance-observability
summary: "Introduce standardized cross-cutting performance telemetry across CLI workflows and web endpoints."
design_refs:
  - docs_v2/08_Features/08_02_Feature_Design/007_cross-cutting-performance-observability_design.md
repo_constraints:
  allowed_paths:
    - "publisher_v2/src/publisher_v2/**"
    - "publisher_v2/tests/**"
    - "docs_v2/**"
  excluded_paths:
    - "code_v1/**"
    - "htmlcov/**"
    - ".git/**"
    - "coverage*.xml"
acceptance_criteria:
  - "CLI workflow logs include standardized per-stage timing fields (*_ms) and a correlation_id for each run."
  - "Web endpoints /api/images/random, /api/images/{filename}/analyze, and /api/images/{filename}/publish log endpoint-level timings (web_*_ms) and correlation_id."
  - "Telemetry fields are emitted via log_json as structured JSON and are suitable for downstream aggregation and analysis."
non_goals:
  - "Introduce a full observability stack (metrics backend, tracing system)."
  - "Change existing CLI or web API contracts, request/response schemas, or core business logic solely for telemetry reasons."
tasks:
  - id: 007.logging_helpers
    type: code
    touches:
      - publisher_v2/src/publisher_v2/utils/logging.py
    contracts:
      signatures:
        - "now_monotonic(): float"
        - "elapsed_ms(start: float) -> int"
  - id: 007.workflow_telemetry
    type: code
    touches:
      - publisher_v2/src/publisher_v2/core/workflow.py
    contracts:
      signatures:
        - "WorkflowOrchestrator.execute(select_filename: str | None = None, dry_publish: bool = False, preview_mode: bool = False) -> WorkflowResult"
    depends_on:
      - 007.logging_helpers
  - id: 007.web_endpoint_telemetry
    type: code
    touches:
      - publisher_v2/src/publisher_v2/web/app.py
      - publisher_v2/src/publisher_v2/web/service.py
    contracts:
      signatures:
        - "api_get_random_image(...) -> ImageResponse"
        - "api_analyze_image(filename: str, request: Request, service: WebImageService) -> AnalysisResponse"
        - "api_publish_image(filename: str, request: Request, body: Optional[PublishRequest], service: WebImageService) -> PublishResponse"
        - "WebImageService.get_random_image(...) -> ImageResponse"
        - "WebImageService.analyze_and_caption(filename: str) -> AnalysisResponse"
        - "WebImageService.publish_image(filename: str, platforms: Optional[List[str]] = None) -> PublishResponse"
    depends_on:
      - 007.logging_helpers
  - id: 007.tests_cli_telemetry
    type: test
    touches:
      - publisher_v2/tests/test_orchestrator_debug.py
  - id: 007.tests_web_telemetry
    type: test
    touches:
      - publisher_v2/tests/web/test_web_service.py
  - id: 007.tests_e2e_telemetry
    type: test
    files_out:
      - publisher_v2/tests/test_e2e_performance_telemetry.py
  - id: 007.docs_telemetry
    type: doc
    touches:
      - docs_v2/06_NFRs/NFRS.md
quality_gates:
  tests_required:
    - 007.tests_cli_telemetry
    - 007.tests_web_telemetry
    - 007.tests_e2e_telemetry
  coverage_delta_min: +2
  perf_budget:
    workflow_e2e_ms: 20000
    web_random_image_ms: 1000
    web_analyze_ms: 5000
    web_publish_ms: 10000
  security_checks:
    - dep-audit
    - no-secrets
    - lint
release:
  strategy: "gradual"
  flags:
    - "features.telemetry_007"
  metrics:
    - "workflow_e2e_ms"
    - "web_random_image_ms"
    - "web_analyze_ms"
    - "web_publish_ms"


