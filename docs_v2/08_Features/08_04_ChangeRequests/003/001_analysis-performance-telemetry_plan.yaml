<!-- docs_v2/08_Features/08_04_ChangeRequests/003/001_analysis-performance-telemetry_plan.yaml -->
version: 1
feature_id: expanded-vision-analysis-json-change-003-001-analysis-performance-telemetry
summary: "Add bounded latency and structured telemetry for VisionAnalyzerOpenAI analysis calls without changing JSON semantics."
design_refs:
  - docs_v2/08_Features/08_04_ChangeRequests/003/001_analysis-performance-telemetry_design.md
  - docs_v2/08_Features/08_02_Feature_Design/003_expanded-vision-analysis-json_design.md
repo_constraints:
  allowed_paths:
    - "publisher_v2/src/publisher_v2/**"
    - "publisher_v2/tests/**"
    - "docs_v2/**"
  excluded_paths:
    - "code_v1/**"
    - "docs_v1/**"
    - "htmlcov/**"
    - "coverage.xml"
    - "coverage-current.xml"
acceptance_criteria:
  - "VisionAnalyzerOpenAI.analyze emits a structured log_json event with event=\"vision_analysis\" and a non-negative vision_analysis_ms for each analysis call."
  - "Analysis calls configure explicit, conservative token limits while preserving the existing ImageAnalysis JSON shape and behavior."
non_goals:
  - "No changes to ImageAnalysis fields, publishers, or storage/archival behavior."
  - "No introduction of a new external metrics backend beyond structured logs."
tasks:
  - id: ai_story003_001.update_vision_analyzer_telemetry
    type: code
    touches:
      - "publisher_v2/src/publisher_v2/services/ai.py"
      - "publisher_v2/src/publisher_v2/utils/logging.py"
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "class VisionAnalyzerOpenAI:"
        - "async def analyze(self, url_or_bytes: str | bytes) -> ImageAnalysis"
    depends_on: []
  - id: ai_story003_001.add_vision_analysis_tests
    type: test
    touches:
      - "publisher_v2/tests/test_ai_vision_analysis_telemetry.py"
    files_out:
      - "publisher_v2/tests/test_ai_vision_analysis_telemetry.py"
    contracts:
      request: {}
      response: {}
      signatures:
        - "async def test_vision_analyzer_logs_timing_success(...)"
        - "async def test_vision_analyzer_logs_timing_on_json_error(...)"
    depends_on:
      - "ai_story003_001.update_vision_analyzer_telemetry"
  - id: ai_story003_001.update_docs_for_analysis_telemetry
    type: doc
    touches:
      - "docs_v2/08_Features/08_04_ChangeRequests/003/001_analysis-performance-telemetry.md"
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures: []
    depends_on:
      - "ai_story003_001.update_vision_analyzer_telemetry"
      - "ai_story003_001.add_vision_analysis_tests"
quality_gates:
  tests_required:
    - "ai_story003_001.add_vision_analysis_tests"
  coverage_delta_min: +1
  perf_budget:
    vision_analysis_p95_ms: 1500
  security_checks:
    - "dep-audit"
    - "no-secrets"
    - "lint"
release:
  strategy: "gradual"
  flags:
    - "features.expanded_vision_analysis_telemetry"
  metrics:
    - "vision_analysis_latency_p95"
    - "vision_analysis_error_rate"


