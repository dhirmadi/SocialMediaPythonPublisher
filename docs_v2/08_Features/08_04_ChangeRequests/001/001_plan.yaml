<!-- docs_v2/08_Features/08_04_ChangeRequests/001/001_plan.yaml -->
version: 1
feature_id: captionfile-change-001-sidecars-as-ai-cache
summary: "Formalize sidecars as a reusable AI cache and expose canonical read semantics in the web layer."
design_refs:
  - docs_v2/08_Features/08_04_ChangeRequests/001/001_design.md
  - docs_v2/08_Features/08_02_Feature_Design/001_captionfile_design.md
repo_constraints:
  allowed_paths:
    - "publisher_v2/src/publisher_v2/**"
    - "publisher_v2/tests/**"
    - "docs_v2/**"
  excluded_paths:
    - "code_v1/**"
    - "docs_v1/**"
    - "htmlcov/**"
    - "coverage.xml"
    - "coverage-current.xml"
acceptance_criteria:
  - "Web sidecar parsing remains backward compatible with the captionfile sidecar format and produces a structured view suitable for reuse."
  - "When a valid sidecar exists, supported web callers can reconstruct caption/sd_caption data from it without changing external HTTP contracts."
non_goals:
  - "Changing the on-disk sidecar format or required metadata fields."
  - "Introducing new persistent storage or altering archive semantics for images or sidecars."
tasks:
  - id: captionfile_change001.code.extend_sidecar_parser_helpers
    type: code
    touches:
      - "publisher_v2/src/publisher_v2/web/sidecar_parser.py"
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "def parse_sidecar_text(text: str) -> tuple[Optional[str], Optional[dict[str, Any]]]"
        - "def rehydrate_sidecar_view(text: str) -> dict[str, Any]"
    depends_on: []
  - id: captionfile_change001.code.web_random_image_sidecar_view
    type: code
    touches:
      - "publisher_v2/src/publisher_v2/web/service.py"
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "class WebImageService:"
        - "    async def get_random_image(self) -> ImageResponse"
    depends_on:
      - captionfile_change001.code.extend_sidecar_parser_helpers
  - id: captionfile_change001.test.sidecar_parser_helpers
    type: test
    touches:
      - "publisher_v2/tests/web/test_sidecar_parser.py"
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures: []
    depends_on:
      - captionfile_change001.code.extend_sidecar_parser_helpers
  - id: captionfile_change001.test.web_service_uses_sidecar_view
    type: test
    touches:
      - "publisher_v2/tests/web/test_web_service.py"
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures: []
    depends_on:
      - captionfile_change001.code.web_random_image_sidecar_view
quality_gates:
  tests_required:
    - captionfile_change001.test.sidecar_parser_helpers
    - captionfile_change001.test.web_service_uses_sidecar_view
  coverage_delta_min: +1
  perf_budget:
    web_random_image_p95_ms: 5000
  security_checks:
    - "dep-audit"
    - "no-secrets"
    - "lint"
release:
  strategy: "gradual"
  flags:
    - "features.captionfile_sidecars_as_ai_cache"
  metrics:
    - "web_random_image_latency_p95"
    - "web_analyze_sd_sidecar_cache_hits"


