<!-- docs_v2/08_Features/08_04_ChangeRequests/005/008_plan.yaml -->

version: 1.0
feature_id: "005-008"
feature_name: "auto-view-anonymous-image-access"
description: "Control whether random images are visible without admin login via AUTO_VIEW flag"
status: "ready"

repo_constraints:
  allowed_paths:
    - "publisher_v2/src/publisher_v2/config/"
    - "publisher_v2/src/publisher_v2/web/"
    - "publisher_v2/tests/web/"
    - "publisher_v2/tests/web_integration/"
    - "docs_v2/"
  excluded_paths:
    - "publisher_v2/src/publisher_v2/core/"
    - "publisher_v2/src/publisher_v2/services/"
  rationale: "Small, focused change to web layer and config wiring; core orchestrator and services remain untouched."

tasks:
  - id: "config-auto-view-flag"
    type: "implementation"
    description: "Add AUTO_VIEW flag to FeaturesConfig and load_application_config"
    files:
      - path: "publisher_v2/src/publisher_v2/config/schema.py"
        action: "modify"
        rationale: "Extend FeaturesConfig with auto_view_enabled boolean"
      - path: "publisher_v2/src/publisher_v2/config/loader.py"
        action: "modify"
        rationale: "Parse AUTO_VIEW from env via parse_bool_env into FeaturesConfig"
    acceptance_criteria:
      - "FeaturesConfig has auto_view_enabled: bool with default False"
      - "AUTO_VIEW env var is parsed using truthy/falsey semantics via parse_bool_env"
      - "Existing config loader tests continue to pass without changes to required INI structure"
    dependencies: []

  - id: "backend-random-image-guard"
    type: "implementation"
    description: "Enforce AUTO_VIEW semantics in /api/images/random and expose flag via /api/config/features"
    files:
      - path: "publisher_v2/src/publisher_v2/web/app.py"
        action: "modify"
        rationale: "Guard api_get_random_image with AUTO_VIEW + admin mode and add auto_view_enabled to /api/config/features response"
    acceptance_criteria:
      - "When AUTO_VIEW=false and admin is configured, /api/images/random returns 403 for non-admin requests"
      - "When AUTO_VIEW=false and admin is not configured, /api/images/random returns 503 with a safe error message"
      - "When AUTO_VIEW=true, /api/images/random behaves as before (200 on success for anonymous clients)"
      - "/api/config/features includes auto_view_enabled boolean"
    dependencies:
      - "config-auto-view-flag"

  - id: "frontend-next-image-behavior"
    type: "implementation"
    description: "Update index.html JS to respect auto_view_enabled and admin state for Next image behavior"
    files:
      - path: "publisher_v2/src/publisher_v2/web/templates/index.html"
        action: "modify"
        rationale: "Gate Next image button and initial load based on AUTO_VIEW and admin mode; show clear status messages"
    acceptance_criteria:
      - "When AUTO_VIEW=false and user is not admin, initial load does not display an image and Next image indicates admin is required"
      - "When AUTO_VIEW=false and admin is logged in, Next image works and images load normally"
      - "When AUTO_VIEW=true, Next image works for non-admin users as before"
      - "Status messages for blocked viewing are human-readable and non-technical"
    dependencies:
      - "backend-random-image-guard"

  - id: "tests-auto-view-backend"
    type: "test"
    description: "Add web integration tests for AUTO_VIEW behavior on /api/images/random"
    files:
      - path: "publisher_v2/tests/web_integration/test_web_auto_view.py"
        action: "add"
        rationale: "Cover AUTO_VIEW=false/true combinations with and without admin configuration"
    test_cases:
      - name: "test_random_requires_admin_when_auto_view_disabled_and_admin_configured"
        description: "AUTO_VIEW=false and web_admin_pw set → /api/images/random without admin cookie returns 403"
      - name: "test_random_allows_admin_when_auto_view_disabled"
        description: "AUTO_VIEW=false and admin logged in → /api/images/random returns 200 and image payload"
      - name: "test_random_unavailable_when_auto_view_disabled_and_admin_unconfigured"
        description: "AUTO_VIEW=false and no web_admin_pw → /api/images/random returns 503"
      - name: "test_random_open_when_auto_view_enabled"
        description: "AUTO_VIEW=true → /api/images/random returns 200 for anonymous client (given a mock image)"
    dependencies:
      - "backend-random-image-guard"

  - id: "tests-auto-view-features-endpoint"
    type: "test"
    description: "Extend /api/config/features tests to assert presence of auto_view_enabled flag"
    files:
      - path: "publisher_v2/tests/web/test_publishers_endpoint.py"
        action: "modify"
        rationale: "Verify auto_view_enabled is present and boolean in /api/config/features response"
    test_cases:
      - name: "test_api_config_features_includes_auto_view_enabled"
        description: "Response contains auto_view_enabled boolean when AUTO_VIEW set or defaulted"
    dependencies:
      - "config-auto-view-flag"
      - "backend-random-image-guard"

  - id: "docs-auto-view"
    type: "documentation"
    description: "Document AUTO_VIEW behavior in change request artifacts"
    files:
      - path: "docs_v2/08_Features/08_04_ChangeRequests/005/008_auto-view-anonymous-image-access.md"
        action: "modify"
        rationale: "Ensure final shipped change request reflects implementation details and semantics"
      - path: "docs_v2/08_Features/08_04_ChangeRequests/005/008_design.md"
        action: "modify"
        rationale: "Update design to 'Shipped' and sync with implementation if needed"
    acceptance_criteria:
      - "AUTO_VIEW semantics (default false, interaction with admin mode) are clearly described"
      - "Artifacts list references plan, tests, and key code paths"
    dependencies:
      - "frontend-next-image-behavior"
      - "tests-auto-view-backend"
      - "tests-auto-view-features-endpoint"

acceptance_criteria:
  - description: "Given AUTO_VIEW=false and admin configured, when non-admin calls /api/images/random, then API and UI do not reveal images and instead require admin login"
    test_type: "integration"
    priority: "must"
  - description: "Given AUTO_VIEW=false and admin configured, when admin logs in and uses Next image, then images load as before with no regression to analysis/publish behavior"
    test_type: "integration"
    priority: "must"
  - description: "Given AUTO_VIEW=true, when a non-admin user loads the UI and clicks Next image, then a random image and caption (if present) appear without requiring admin login"
    test_type: "integration"
    priority: "must"
  - description: "Given AUTO_VIEW is unset, when the app runs, then behavior matches AUTO_VIEW=false and all existing tests for admin visibility, responsive layout, and feature toggles still pass"
    test_type: "regression"
    priority: "must"

quality_gates:
  test_coverage:
    enabled: true
    coverage_delta_min: 0
    rationale: "New logic covered by focused web + integration tests; no reduction in overall coverage"
  linting:
    enabled: true
    must_pass: true
  type_checking:
    enabled: true
    must_pass: true
  backwards_compatibility:
    enabled: true
    checks:
      - "Existing CLI behavior unchanged"
      - "Admin-mode flow for analyze/publish/keep/remove unchanged"
      - "Existing web tests (admin visibility, publishers config) remain green"

release:
  changelog_entry: |
    ### Web UI – AUTO_VIEW Anonymous Image Access
    - Added AUTO_VIEW env flag to control whether random images are visible without admin login.
    - When AUTO_VIEW=false (default), images require admin mode; when true, images remain viewable by any visitor while admin-only actions stay protected.
    - Extended /api/config/features and web UI to surface and respect this flag.
  deployment_notes: |
    - New env var: AUTO_VIEW (truthy/falsey; default is false/private).
    - For strict private deployments, leave AUTO_VIEW unset or set to false and configure web_admin_pw.
    - For viewer-friendly deployments, set AUTO_VIEW=true; admin mode is still required for analyze/publish/keep/remove.
  rollback_plan: |
    - Revert changes to config.schema, config.loader, web.app, and index.html.
    - Remove AUTO_VIEW from deployment environment.
    - Existing admin and web behavior will revert to pre-change semantics.

estimated_effort_hours: 3.0

risks:
  - risk: "AUTO_VIEW misconfiguration could unintentionally expose or hide images"
    mitigation: "Default to false/private; fail closed with 503 when admin is not configured; document semantics clearly"
    severity: "medium"
  - risk: "Inconsistent enforcement between backend and frontend could allow bypass via direct API calls"
    mitigation: "Implement AUTO_VIEW checks in /api/images/random before any business logic; treat UI behavior as an additional guard only"
    severity: "medium"


