version: 1
feature_id: central-config-i18n-text
summary: >
  Introduce a static configuration layer for AI prompts, platform limits, service limits, preview text, and web UI text,
  clearly separating secrets, dynamic configuration, and static text/rules while keeping behavior backward-compatible by default.
design_refs:
  - docs_v2/08_Features/08_02_Feature_Design/012_central-config-i18n-text_design.md
repo_constraints:
  allowed_paths:
    - publisher_v2/src/publisher_v2/**
    - publisher_v2/tests/**
    - docs_v2/**
    - configfiles/**
  excluded_paths:
    - code_v1/**
    - docs_v1/**
    - htmlcov/**
    - coverage.xml
    - coverage-current.xml
acceptance_criteria:
  - "Behavior of CLI and web flows is unchanged when static config files are absent (all defaults match current behavior)."
  - "AI prompts for vision analysis, captioning, and SD-caption are overridable via ai_prompts.yaml without code changes."
  - "Platform-specific caption lengths, hashtag limits, and resize widths are defined in platform_limits.yaml and honored by formatting logic."
  - "Web UI user-facing strings and preview-mode headings come from static text config files with English defaults."
  - "Service limits (OpenAI rate-per-minute, Instagram delay range, web image cache TTL) are configurable via service_limits.yaml with env overrides where appropriate."
  - "Configuration docs clearly distinguish secrets, dynamic variables, and static text/rules, and reference the new static config files."
non_goals:
  - "Changing CLI flags or web API shapes."
  - "Implementing runtime locale negotiation or a language switcher."
  - "Moving every minor log or debug string into static config."
  - "Refactoring orchestrator or publishers beyond what is required to read static config values."
tasks:
  - id: config.static_loader.add_module
    type: code
    touches:
      - publisher_v2/src/publisher_v2/config/static_loader.py
      - publisher_v2/src/publisher_v2/config/static/ai_prompts.yaml
      - publisher_v2/src/publisher_v2/config/static/platform_limits.yaml
      - publisher_v2/src/publisher_v2/config/static/preview_text.yaml
      - publisher_v2/src/publisher_v2/config/static/web_ui_text.en.yaml
      - publisher_v2/src/publisher_v2/config/static/service_limits.yaml
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "class AIPromptsConfig"
        - "class PlatformLimitsConfig"
        - "class PreviewTextConfig"
        - "class WebUITextConfig"
        - "class ServiceLimitsConfig"
        - "class StaticConfig"
        - "def load_static_config(base_dir: str | None = None) -> StaticConfig"
        - "def get_static_config() -> StaticConfig"
    depends_on: []
    rollback: "Remove static_loader module and static YAML files; callers fall back to existing in-code defaults."

  - id: config.static_loader.tests
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/test_static_config_loader.py
    contracts:
      request: {}
      response: {}
      signatures:
        - "def test_static_config_loads_packaged_defaults() -> None"
        - "def test_static_config_missing_files_use_defaults() -> None"
        - "def test_static_config_invalid_yaml_logs_and_uses_defaults() -> None"
    depends_on:
      - config.static_loader.add_module
    rollback: ""

  - id: ai.integrate_static_prompts
    type: code
    touches:
      - publisher_v2/src/publisher_v2/services/ai.py
      - publisher_v2/src/publisher_v2/config/__init__.py
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "class VisionAnalyzerOpenAI"
        - "class CaptionGeneratorOpenAI"
        - "from publisher_v2.config.static_loader import get_static_config"
    depends_on:
      - config.static_loader.add_module
    rollback: "Remove static prompt lookups and revert to current hard-coded prompts and INI-based overrides."

  - id: ai.integrate_static_prompts.tests
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/test_ai_static_prompts.py
    contracts:
      request: {}
      response: {}
      signatures:
        - "async def test_vision_analyzer_uses_static_prompts_when_config_present() -> None"
        - "async def test_caption_generator_uses_static_prompts_with_fallbacks() -> None"
    depends_on:
      - ai.integrate_static_prompts
    rollback: ""

  - id: captions.platform_limits_static
    type: code
    touches:
      - publisher_v2/src/publisher_v2/utils/captions.py
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "_MAX_LEN"
        - "def format_caption(platform: str, caption: str) -> str"
        - "from publisher_v2.config.static_loader import get_static_config"
    depends_on:
      - config.static_loader.add_module
    rollback: "Restore current hard-coded _MAX_LEN map and Instagram hashtag limit."

  - id: captions.platform_limits_static.tests
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/test_captions_platform_limits_static.py
    contracts:
      request: {}
      response: {}
      signatures:
        - "def test_format_caption_uses_platform_limits_defaults() -> None"
        - "def test_instagram_hashtag_limit_comes_from_platform_limits() -> None"
    depends_on:
      - captions.platform_limits_static
    rollback: ""

  - id: preview.preview_text_static
    type: code
    touches:
      - publisher_v2/src/publisher_v2/utils/preview.py
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "def print_preview_header() -> None"
        - "def print_vision_analysis(analysis, model, feature_enabled: bool = True) -> None"
        - "def print_caption(caption: str, spec, model: str, hashtag_count: int, feature_enabled: bool = True) -> None"
        - "def print_platform_preview("
        - "def print_preview_footer() -> None"
        - "from publisher_v2.config.static_loader import get_static_config"
    depends_on:
      - config.static_loader.add_module
    rollback: "Revert preview text functions to use current hard-coded English strings."

  - id: preview.preview_text_static.tests
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/test_preview_text_static.py
    contracts:
      request: {}
      response: {}
      signatures:
        - "def test_preview_header_uses_static_text_defaults(capsys) -> None"
        - "def test_preview_footer_uses_static_text_defaults(capsys) -> None"
    depends_on:
      - preview.preview_text_static
    rollback: ""

  - id: web.ui_text_static
    type: code
    touches:
      - publisher_v2/src/publisher_v2/web/app.py
      - publisher_v2/src/publisher_v2/web/templates/index.html
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "async def index(request: Request) -> HTMLResponse"
        - "window.WEB_UI_TEXT"
    depends_on:
      - config.static_loader.add_module
    rollback: "Remove web_ui_text injection and restore current hard-coded strings in index.html."

  - id: web.ui_text_static.tests
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/test_web_ui_text_static.py
    contracts:
      request: {}
      response: {}
      signatures:
        - "async def test_web_ui_uses_static_text_defaults(client) -> None"
    depends_on:
      - web.ui_text_static
    rollback: ""

  - id: services.service_limits_static
    type: code
    touches:
      - publisher_v2/src/publisher_v2/services/ai.py
      - publisher_v2/src/publisher_v2/web/service.py
      - publisher_v2/src/publisher_v2/services/publishers/instagram.py
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "class AIService"
        - "class WebImageService"
        - "class InstagramPublisher"
        - "from publisher_v2.config.static_loader import get_static_config"
    depends_on:
      - config.static_loader.add_module
    rollback: "Restore hard-coded AI rate limiter value, WebImageService cache TTL, and Instagram delay_range."

  - id: services.service_limits_static.tests
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/test_service_limits_static.py
    contracts:
      request: {}
      response: {}
      signatures:
        - "async def test_ai_service_uses_service_limits_default_rate() -> None"
        - "async def test_web_image_cache_ttl_uses_service_limits_default() -> None"
        - "def test_instagram_delay_range_uses_service_limits_default() -> None"
    depends_on:
      - services.service_limits_static
    rollback: ""

  - id: docs.update_configuration_model
    type: doc
    touches:
      - docs_v2/05_Configuration/CONFIGURATION.md
      - docs_v2/03_Architecture/ARCHITECTURE.md
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures: []
    depends_on:
      - config.static_loader.add_module
      - ai.integrate_static_prompts
      - captions.platform_limits_static
      - preview.preview_text_static
      - web.ui_text_static
      - services.service_limits_static
    rollback: "Remove or revert sections describing the static config layer and new config files."

quality_gates:
  tests_required:
    - config.static_loader.tests
    - ai.integrate_static_prompts.tests
    - captions.platform_limits_static.tests
    - preview.preview_text_static.tests
    - web.ui_text_static.tests
    - services.service_limits_static.tests
  coverage_delta_min: +3
  perf_budget:
    workflow_execution_p95_ms: 0
  security_checks:
    - dep-audit
    - no-secrets
    - lint
release:
  strategy: immediate
  flags: []
  migration_notes:
    - "Static config files are optional; when absent, behavior and text match current defaults."
    - "Operators can override prompts, limits, and text by providing customized YAML files under a configured static config directory."
    - "Secrets remain in environment variables and must never be added to the new static YAML files."


