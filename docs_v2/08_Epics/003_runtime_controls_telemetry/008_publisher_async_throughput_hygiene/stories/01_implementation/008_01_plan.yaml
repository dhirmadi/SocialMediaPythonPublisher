version: 1
feature_id: publisher-async-throughput-hygiene
summary: "Ensure existing publishers use async-safe patterns and per-publisher telemetry so multi-platform publishing remains effectively concurrent."
design_refs:
  - docs_v2/08_Epics/08_02_Feature_Design/008_publisher-async-throughput-hygiene_design.md
repo_constraints:
  allowed_paths:
    - publisher_v2/src/publisher_v2/services/publishers
    - publisher_v2/src/publisher_v2/utils
    - publisher_v2/tests
    - docs_v2/08_Epics
  excluded_paths:
    - code_v1
    - docs_v1
acceptance_criteria:
  - "With all publishers enabled and healthy externals, total publish time approximately matches the slowest single publisher rather than the sum of all."
  - "Publishers that use blocking SDKs or image resizing do not block the event loop; heavy work is offloaded via asyncio.to_thread or async helpers."
  - "Tests show multi-platform publishing latency grows modestly with additional platforms, not linearly."
  - "Preview and dry-run modes remain functionally unchanged while respecting async-safe publisher patterns."
non_goals:
  - "Adding new publishing platforms or changing platform-specific business rules."
  - "Introducing new queues, schedulers, or background workers for publishers."
  - "Changing preview/dry-run semantics or sidecar/AI behavior."
tasks:
  - id: async_hygiene.add_async_image_helper
    type: code
    touches:
      - publisher_v2/src/publisher_v2/utils/images.py
    contracts:
      signatures:
        - "async def ensure_max_width_async(image_path: str, max_width: int = 1280) -> str"
  - id: async_hygiene.refactor_telegram_publisher
    type: code
    touches:
      - publisher_v2/src/publisher_v2/services/publishers/telegram.py
      - publisher_v2/src/publisher_v2/utils/images.py
    contracts:
      signatures:
        - "class TelegramPublisher(Publisher)"
        - "async def publish(self, image_path: str, caption: str, context: Optional[dict] = None) -> PublishResult"
    depends_on:
      - async_hygiene.add_async_image_helper
  - id: async_hygiene.refactor_instagram_publisher
    type: code
    touches:
      - publisher_v2/src/publisher_v2/services/publishers/instagram.py
      - publisher_v2/src/publisher_v2/utils/images.py
    contracts:
      signatures:
        - "class InstagramPublisher(Publisher)"
        - "async def publish(self, image_path: str, caption: str, context: Optional[dict] = None) -> PublishResult"
    depends_on:
      - async_hygiene.add_async_image_helper
  - id: async_hygiene.add_publisher_timing_logs
    type: code
    touches:
      - publisher_v2/src/publisher_v2/services/publishers/email.py
      - publisher_v2/src/publisher_v2/services/publishers/telegram.py
      - publisher_v2/src/publisher_v2/services/publishers/instagram.py
      - publisher_v2/src/publisher_v2/utils/logging.py
    contracts:
      signatures:
        - "def log_publisher_publish(logger: logging.Logger, platform: str, start: float, success: bool, error: str | None = None) -> None"
    depends_on:
      - async_hygiene.add_async_image_helper
  - id: async_hygiene.add_concurrency_and_logging_tests
    type: test
    files_out:
      - publisher_v2/tests/test_publisher_async_throughput.py
    depends_on:
      - async_hygiene.refactor_telegram_publisher
      - async_hygiene.refactor_instagram_publisher
      - async_hygiene.add_publisher_timing_logs
  - id: async_hygiene.update_feature_docs
    type: doc
    touches:
      - docs_v2/08_Epics/08_02_Feature_Design/008_publisher-async-throughput-hygiene_design.md
      - docs_v2/08_Epics/007-cross-cutting-performance-observability.md
quality_gates:
  tests_required:
    - async_hygiene.add_concurrency_and_logging_tests
  coverage_delta_min: +2
  perf_budget:
    publish_parallel_ms_p95: 10000
  security_checks:
    - dep-audit
    - no-secrets
    - lint
release:
  strategy: "gradual"
  flags: []
  metrics:
    - "workflow.publish_parallel_ms"
    - "publisher.publish_duration_ms_by_platform"


