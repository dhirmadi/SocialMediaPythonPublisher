version: 1
feature_id: core-workflow-dedup-performance
story_id: 01_metadata_infrastructure
summary: "Extend storage and state layers to support Dropbox content_hashes for deduplication."
design_refs:
  - docs_v2/08_Epics/000_v2_foundation/006_core_workflow_dedup_performance/006_design.md
repo_constraints:
  allowed_paths:
    - publisher_v2/src/publisher_v2/**
    - publisher_v2/tests/**
    - docs_v2/**

acceptance_criteria:
  - "Given a Dropbox folder, list_images_with_hashes returns tuples of (filename, content_hash)."
  - "Given a posted.json file, load_posted_content_hashes reads the new 'dropbox_content_hashes' field."
  - "Given a new content hash, save_posted_content_hash appends it to the state file while preserving existing data."

tasks:
  # 1. Storage Layer
  - id: dedup.storage_list_hashes
    type: code
    touches:
      - publisher_v2/src/publisher_v2/services/storage.py
    files_out: []
    contracts:
      signatures:
        - "async def list_images_with_hashes(self, folder: str) -> List[Tuple[str, str]]"

  # 2. State Management
  - id: dedup.state_content_hashes
    type: code
    touches:
      - publisher_v2/src/publisher_v2/utils/state.py
    files_out: []
    contracts:
      signatures:
        - "def load_posted_content_hashes() -> Set[str]"
        - "def save_posted_content_hash(hash_value: str) -> None"

  # Tests
  - id: dedup.tests_infrastructure
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/test_storage_dedup.py
      - publisher_v2/tests/test_state_dedup.py # Integrated into test_utils_support.py in practice

quality_gates:
  tests_required:
    - dedup.tests_infrastructure

