version: 1
feature_id: stable-diffusion-caption-file
summary: "Add Stable-Diffusion-ready caption and .txt sidecar with archive support, backward-compatible."
design_refs:
  - docs_v2/08_Epics/08_02_Feature_Design/001_captionfile_design.md
repo_constraints:
  allowed_paths: [ "publisher_v2/src/publisher_v2/**", "publisher_v2/tests/**", "docs_v2/**" ]
  excluded_paths: [ "code_v1/**", "docs_v1/**" ]
acceptance_criteria:
  - "Add sd_caption to analysis output without changing existing fields or semantics."
  - "Write <image>.txt beside the image with only sd_caption; overwrite if exists."
  - "On archive, move image and its .txt sidecar to the archive folder together."
  - "Prefer single caption-model call returning {caption, sd_caption}; fall back to legacy string caption when disabled or on error."
  - "If sd_caption generation or sidecar upload fails, continue publishing; log at INFO/ERROR appropriately."
  - "Preview mode displays sd_caption; still no side effects in preview."
  - "PG-13 fine-art phrasing; include pose, styling/material, lighting, mood."
  - "Feature is configurable via flags and model/prompt options; defaults keep behavior enabled and backward-compatible."
non_goals: [ "Change existing analysis fields or values", "Modify publisher-specific formatting/logic", "Introduce database storage", "Generate sidecar after archive" ]
tasks:
  - id: code.core-models.sd_caption_field
    type: code
    touches: [ "publisher_v2/src/publisher_v2/core/models.py" ]
    contracts:
      signatures: [ "class ImageAnalysis: sd_caption: Optional[str] = None" ]
  - id: code.config.add_sd_flags
    type: code
    touches: [ "publisher_v2/src/publisher_v2/config/schema.py", "publisher_v2/src/publisher_v2/config/loader.py" ]
    contracts:
      request: { INI.[openAI].sd_caption_enabled: bool, INI.[openAI].sd_caption_single_call_enabled: bool, INI.[openAI].sd_caption_model: str?, INI.[openAI].sd_caption_system_prompt: str?, INI.[openAI].sd_caption_role_prompt: str? }
      response: { ApplicationConfig.openai.sd_caption_enabled: bool, ApplicationConfig.openai.sd_caption_single_call_enabled: bool, ApplicationConfig.openai.sd_caption_model: str?, ApplicationConfig.openai.sd_caption_system_prompt: str?, ApplicationConfig.openai.sd_caption_role_prompt: str? }
      signatures:
        - "class OpenAIConfig: sd_caption_enabled: bool = True"
        - "class OpenAIConfig: sd_caption_single_call_enabled: bool = True"
        - "class OpenAIConfig: sd_caption_model: Optional[str] = None"
        - "class OpenAIConfig: sd_caption_system_prompt: Optional[str] = None"
        - "class OpenAIConfig: sd_caption_role_prompt: Optional[str] = None"
        - "load_application_config(config_file_path: str, env_path: str | None = None) -> ApplicationConfig"
  - id: code.ai.generate_with_sd
    type: code
    touches: [ "publisher_v2/src/publisher_v2/services/ai.py" ]
    contracts:
      request: { analysis: ImageAnalysis, spec: CaptionSpec }
      response: { caption: str, sd_caption: str }
      signatures:
        - "class CaptionGeneratorOpenAI: async def generate_with_sd(self, analysis: ImageAnalysis, spec: CaptionSpec) -> dict[str, str]"
        - "class AIService: async def create_caption_pair(self, url_or_bytes: str | bytes, spec: CaptionSpec) -> tuple[str, Optional[str]]"
    depends_on: [ "code.core-models.sd_caption_field", "code.config.add_sd_flags" ]
  - id: code.storage.sidecar_write
    type: code
    touches: [ "publisher_v2/src/publisher_v2/services/storage.py" ]
    contracts:
      request: { folder: str, filename: str, text: str }
      response: { ok: bool }
      signatures:
        - "class DropboxStorage: async def write_sidecar_text(self, folder: str, filename: str, text: str) -> None"
  - id: code.storage.archive_move_sidecar
    type: code
    touches: [ "publisher_v2/src/publisher_v2/services/storage.py" ]
    contracts:
      signatures:
        - "class DropboxStorage: async def archive_image(self, folder: str, filename: str, archive_folder: str) -> None  # updated to also move <filename>.txt if present"
    depends_on: [ "code.storage.sidecar_write" ]
  - id: code.workflow.integrate_sd
    type: code
    touches: [ "publisher_v2/src/publisher_v2/core/workflow.py", "publisher_v2/src/publisher_v2/utils/logging.py" ]
    contracts:
      signatures:
        - "class WorkflowOrchestrator: async def execute(self, select_filename: str | None = None, dry_publish: bool = False, preview_mode: bool = False) -> WorkflowResult"
      request: { flags: { sd_caption_enabled: bool, sd_caption_single_call_enabled: bool }, image: str }
      response: { sidecar_written: bool, logs: [ "sd_caption_start|complete|error", "sidecar_upload_start|complete|error" ] }
    depends_on: [ "code.core-models.sd_caption_field", "code.config.add_sd_flags", "code.ai.generate_with_sd", "code.storage.sidecar_write" ]
  - id: code.preview.print_sd_caption
    type: code
    touches: [ "publisher_v2/src/publisher_v2/utils/preview.py" ]
    contracts:
      signatures:
        - "def print_vision_analysis(analysis: ImageAnalysis, model: str) -> None  # updated to include sd_caption when present"
    depends_on: [ "code.core-models.sd_caption_field" ]
  - id: doc.plan_file
    type: doc
    files_out: [ "docs_v2/08_Epics/08_03_Feature_plan/001_captionfile_design_plan.yaml" ]
  - id: doc.update_configuration
    type: doc
    touches: [ "docs_v2/05_Configuration/CONFIGURATION.md", "docs_v2/08_Epics/08_01_Feature_Request/001_captionfile.md", "docs_v2/01_Overview/README.md" ]
    depends_on: [ "code.config.add_sd_flags", "code.storage.sidecar_write", "code.storage.archive_move_sidecar", "code.workflow.integrate_sd" ]
  - id: test.unit.ai_generate_with_sd
    type: test
    files_out: [ "publisher_v2/tests/test_ai_sd_generate.py" ]
    contracts:
      request: { mock_openai_json: { caption: "c", sd_caption: "s" } }
      response: { parsed_caption: "c", parsed_sd_caption: "s", pg13: true }
    depends_on: [ "code.ai.generate_with_sd" ]
  - id: test.unit.storage_sidecar
    type: test
    files_out: [ "publisher_v2/tests/test_dropbox_sidecar.py" ]
    contracts:
      request: { folder: "/ImagesToday", filename: "image.jpg", text: "sd caption" }
      response: { uploaded_path: "/ImagesToday/image.txt", overwrite: true }
    depends_on: [ "code.storage.sidecar_write" ]
  - id: test.unit.archive_with_sidecar
    type: test
    files_out: [ "publisher_v2/tests/test_archive_with_sidecar.py" ]
    contracts:
      request: { src_folder: "/ImagesToday", filename: "image.jpg", archive_folder: "archive" }
      response: { moved: [ "/ImagesToday/archive/image.jpg", "/ImagesToday/archive/image.txt" ] }
    depends_on: [ "code.storage.archive_move_sidecar" ]
  - id: test.unit.workflow_sd_integration
    type: test
    files_out: [ "publisher_v2/tests/test_workflow_sd_integration.py" ]
    contracts:
      request: { sd_caption_enabled: true, single_call: true }
      response: { analysis_has_sd_caption: true, sidecar_written_called: true }
    depends_on: [ "code.workflow.integrate_sd" ]
  - id: test.unit.preview_sd_caption
    type: test
    files_out: [ "publisher_v2/tests/test_preview_sd_caption.py" ]
    contracts:
      request: { analysis.sd_caption: "fine-art portrait ..." }
      response: { printed_contains: "sd_caption" }
    depends_on: [ "code.preview.print_sd_caption" ]
  - id: test.e2e.sd_caption_preview_and_archive
    type: test
    files_out: [ "publisher_v2/tests/test_e2e_sd_caption.py" ]
    contracts:
      request: { mode: "preview_then_live", mocks: [ "OpenAI", "Dropbox" ] }
      response: { preview_shows_sd_caption: true, live_moves_sidecar: true, no_side_effects_in_preview: true }
    depends_on: [ "code.workflow.integrate_sd", "code.storage.archive_move_sidecar", "code.preview.print_sd_caption" ]
quality_gates:
  tests_required: [ "test.unit.ai_generate_with_sd", "test.unit.storage_sidecar", "test.unit.archive_with_sidecar", "test.unit.workflow_sd_integration", "test.unit.preview_sd_caption", "test.e2e.sd_caption_preview_and_archive" ]
  coverage_delta_min: +2
  perf_budget:
    sd_caption_single_call_ms: 3500
    sidecar_upload_ms: 500
    archive_with_sidecar_ms: 800
  security_checks: [ "dep-audit", "no-secrets", "lint" ]
release:
  strategy: "gradual"
  flags: [ "features.sd_caption_enabled", "features.sd_caption_single_call_enabled" ]
  metrics: [ "sd_caption_success_total", "sd_caption_error_total", "sidecar_upload_error_total", "sd_caption_latency_ms_p95" ]

