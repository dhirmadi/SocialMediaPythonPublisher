version: 1
feature_id: web-interface-mvp-change-001-web-interface-admin-controls
summary: "Add an admin-only mode to the Web Interface MVP so only the administrator can trigger Analyze & caption and Publish and see detailed status, while captions remain visible to all."
design_refs:
  - docs_v2/08_Epics/08_04_ChangeRequests/005/001_web-interface-admin-controls_design.md
  - docs_v2/08_Epics/08_02_Feature_Design/005_web-interface-mvp_design.md
repo_constraints:
  allowed_paths:
    - "publisher_v2/src/publisher_v2/**"
    - "publisher_v2/tests/**"
    - "docs_v2/**"
  excluded_paths:
    - "code_v1/**"
    - "docs_v1/**"
    - "htmlcov/**"
    - "coverage.xml"
    - "coverage-current.xml"
acceptance_criteria:
  - "Given the web interface is loaded and no admin password has been entered, when a user views the page, then Analyze & caption and Publish controls are either hidden or clearly disabled and cannot be triggered, while the caption (if present) remains visible."
  - "Given the .env file contains a valid web_admin_pw and the operator clicks the Administration control and enters the correct password, when the password is accepted, then the UI enters admin mode and the Analyze & caption and Publish buttons become available and clickable, and the status information becomes visible, with admin mode tracked via a cookie that expires in less than one hour."
  - "Given the application is started without a web_admin_pw environment variable, when a user opens the web interface, then admin mode is not available at all and the UI clearly indicates that admin-only actions are disabled while still allowing image + caption viewing."
non_goals:
  - "Introduce any new persistent database or storage beyond existing Dropbox and sidecar files."
  - "Implement a full user management or multi-role access control system."
  - "Replace or weaken existing HTTP-level authentication (WEB_AUTH_TOKEN, basic auth) defined in the Web Interface MVP design."
  - "Change CLI workflows or their configuration and behavior."
tasks:
  - id: web_admin.read_config
    type: code
    touches:
      - "publisher_v2/src/publisher_v2/config/schema.py"
      - "publisher_v2/src/publisher_v2/config/loader.py"
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "class WebConfig(BaseModel)"
        - "class ApplicationConfig(BaseModel)"
        - "def load_application_config(config_path: str | None = None) -> ApplicationConfig"
    depends_on: []
    rollback: ""
  - id: web_admin.auth_helpers
    type: code
    touches:
      - "publisher_v2/src/publisher_v2/web/auth.py"
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "def verify_admin_password(candidate: str, actual: str) -> bool"
        - "def set_admin_cookie(response, expires_in_seconds: int) -> None"
        - "def clear_admin_cookie(response) -> None"
        - "def is_admin_request(request) -> bool"
        - "def require_admin(request) -> None"
    depends_on:
      - web_admin.read_config
    rollback: ""
  - id: web_admin.endpoints
    type: code
    touches:
      - "publisher_v2/src/publisher_v2/web/app.py"
    files_out: []
    contracts:
      request:
        POST_/api/admin/login: "{password:string}"
        GET_/api/admin/status: "none"
        POST_/api/images/{filename}/analyze: "path: filename:string"
        POST_/api/images/{filename}/publish: "path: filename:string; body: {platforms?: string[]}"
      response:
        POST_/api/admin/login: "{admin:boolean,error?:string}"
        GET_/api/admin/status: "{admin:boolean}"
        POST_/api/images/{filename}/analyze: "{...existing fields...,admin_required:boolean}"
        POST_/api/images/{filename}/publish: "{...existing fields...,admin_required:boolean}"
      signatures:
        - "@app.post('/api/admin/login') async def api_admin_login(payload: AdminLoginRequest, response: Response) -> AdminStatusResponse"
        - "@app.get('/api/admin/status') async def api_admin_status(request: Request) -> AdminStatusResponse"
        - "@app.post('/api/images/{filename}/analyze') async def api_analyze_image(filename: str, request: Request) -> AnalysisResponse"
        - "@app.post('/api/images/{filename}/publish') async def api_publish_image(filename: str, request: Request, req: PublishRequest | None = None) -> PublishResponse"
    depends_on:
      - web_admin.auth_helpers
    rollback: ""
  - id: web_admin.templates
    type: code
    touches:
      - "publisher_v2/src/publisher_v2/web/templates/index.html"
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures:
        - "<button id=\"admin-toggle\">Administration</button>"
        - "<form id=\"admin-login-form\">"
        - "<span id=\"admin-mode-indicator\"></span>"
        - "<button id=\"analyze-button\" ...>"
        - "<button id=\"publish-button\" ...>"
    depends_on:
      - web_admin.endpoints
    rollback: ""
  - id: web_admin.unit_tests_auth
    type: test
    touches: []
    files_out:
      - "publisher_v2/tests/web/test_web_auth_admin.py"
    contracts:
      request: {}
      response: {}
      signatures:
        - "def test_verify_admin_password_matches() -> None"
        - "def test_require_admin_rejects_without_cookie() -> None"
        - "def test_require_admin_accepts_with_valid_cookie(test_client) -> None"
    depends_on:
      - web_admin.auth_helpers
    rollback: ""
  - id: web_admin.integration_tests_endpoints
    type: test
    touches: []
    files_out:
      - "publisher_v2/tests/web_integration/test_web_admin_endpoints.py"
    contracts:
      request: {}
      response: {}
      signatures:
        - "async def test_admin_login_success(client) -> None"
        - "async def test_admin_login_failure(client) -> None"
        - "async def test_admin_status_and_cookie_flow(client) -> None"
        - "async def test_analyze_publish_require_admin(client) -> None"
    depends_on:
      - web_admin.endpoints
    rollback: ""
  - id: web_admin.docs
    type: doc
    touches:
      - "docs_v2/08_Epics/08_03_Implementation/005_web-interface-mvp.md"
      - "docs_v2/08_Epics/08_04_ChangeRequests/005/001_web-interface-admin-controls.md"
    files_out: []
    contracts:
      request: {}
      response: {}
      signatures: []
    depends_on:
      - web_admin.templates
    rollback: ""
quality_gates:
  tests_required:
    - web_admin.unit_tests_auth
    - web_admin.integration_tests_endpoints
  coverage_delta_min: +1
  perf_budget:
    web_admin_login_p95_ms: 100
  security_checks:
    - "dep-audit"
    - "no-secrets"
    - "lint"
release:
  strategy: "gradual"
  flags:
    - "features.web_interface_mvp_admin_mode"
  metrics:
    - "web_admin_login_total"
    - "web_admin_actions_total"
    - "web_admin_login_p95_ms"


