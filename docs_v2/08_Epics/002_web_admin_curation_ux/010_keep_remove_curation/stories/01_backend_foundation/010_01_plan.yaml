version: 1
feature_id: keep-remove-curation
story_id: 01_backend_foundation
summary: "Implement core backend support for Keep/Remove curation, including config schema, storage move helpers, and workflow orchestration logic with preview safety."
design_refs:
  - docs_v2/08_Epics/08_02_Feature_Design/010_keep-remove-curation_design.md
repo_constraints:
  allowed_paths:
    - publisher_v2/src/publisher_v2/**
    - publisher_v2/tests/**
    - docs_v2/**
    - configfiles/**

acceptance_criteria:
  - "Given [Dropbox].folder_keep and [Dropbox].folder_remove are set in INI and/or overridden via .env, when the config loader runs, then DropboxConfig exposes these values with legacy folder_reject mapped to folder_remove if missing."
  - "Given malformed keep/remove folder values containing slashes or '..', when configuration is loaded, then a ConfigurationError is raised."
  - "Given an image and sidecar, when move_image_with_sidecars is called, then both files are moved to the target subfolder on Dropbox."
  - "Given the workflow runs in preview or dry mode, when keep_image/remove_image is invoked through the orchestrator, then no Dropbox moves occur and preview utilities print what would happen."
  - "Given FEATURE_KEEP_CURATE=false or FEATURE_REMOVE_CURATE=false, when the orchestrator curation methods are called, then a StorageError is raised."

tasks:
  # 1. Config & schema
  - id: keep_remove.extend_dropbox_schema
    type: code
    touches:
      - publisher_v2/src/publisher_v2/config/schema.py
    files_out: []
    contracts:
      signatures:
        - "class DropboxConfig(BaseModel)"
        - "class FeaturesConfig(BaseModel)"

  - id: keep_remove.update_config_loader
    type: code
    touches:
      - publisher_v2/src/publisher_v2/config/loader.py
    files_out: []
    contracts:
      signatures:
        - "def load_application_config(config_file_path: str, env_path: str | None = None) -> ApplicationConfig"
    depends_on:
      - keep_remove.extend_dropbox_schema

  # 2. Storage helpers
  - id: keep_remove.add_move_with_sidecars
    type: code
    touches:
      - publisher_v2/src/publisher_v2/services/storage.py
    files_out: []
    contracts:
      signatures:
        - "class DropboxStorage"
        - "async def move_image_with_sidecars(self, folder: str, filename: str, target_subfolder: str) -> None"

  # 3. Workflow orchestration
  - id: keep_remove.add_orchestrator_curation_methods
    type: code
    touches:
      - publisher_v2/src/publisher_v2/core/workflow.py
    files_out: []
    contracts:
      signatures:
        - "class WorkflowOrchestrator"
        - "async def keep_image(self, filename: str, *, preview_mode: bool = False, dry_run: bool = False) -> None"
        - "async def remove_image(self, filename: str, *, preview_mode: bool = False, dry_run: bool = False) -> None"
    depends_on:
      - keep_remove.extend_dropbox_schema
      - keep_remove.add_move_with_sidecars

  # 4. Preview helpers
  - id: keep_remove.update_preview_utils
    type: code
    touches:
      - publisher_v2/src/publisher_v2/utils/preview.py
    files_out: []
    contracts:
      signatures:
        - "def print_curation_action(filename: str, source_folder: str, target_subfolder: str, action: str) -> None"
    depends_on:
      - keep_remove.add_orchestrator_curation_methods

  # Tests
  - id: keep_remove.tests_config_loader
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/test_config_keep_remove.py

  - id: keep_remove.tests_storage_move_with_sidecars
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/test_dropbox_keep_remove_move.py

  - id: keep_remove.tests_orchestrator_curation
    type: test
    touches: []
    files_out:
      - publisher_v2/tests/test_workflow_keep_remove.py

quality_gates:
  tests_required:
    - keep_remove.tests_config_loader
    - keep_remove.tests_storage_move_with_sidecars
    - keep_remove.tests_orchestrator_curation

